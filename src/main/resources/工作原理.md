
STUN探测过程:

---->1.Client向Server1：Port1发送UDP包,Server1收到UDP包后，从UDP包中获取NAT的IP和PORT,保存在Server1并写到UDP中,返回给Client
    -->这里的Server1和Client得到NAT的IP和PORT
    -->比较NAT的IP和PORT和Client的相对比,如果一样,证明Client是在公网上,就不用进行NAT了,直接建立服务.如果不一样,说明存在NAT，进行第2步

---->2.Client向Server1：port1发送UDP包，然后Server1向Server2:PORT(并非PORT2)发送UDP包，让Server2向B返回一个UDP包。
    -->当Client能收到从Server2返回的UDP包，说明Client端的NAT来者不拒，符合STUN标准的Full cone NAT
    -->当Client不能收到从Server2返回的UDP包，进行第3步

---->3.Client向Server2:PORT2发送UDP包，Server2从UDP包中获取NAT的IP和PORT，保存在Server2并将NAT的 IP和PORT写到UDP，返回给Client
    -->当UDP包与第1步中的UDP包的NAT的IP和PORT相比，如果PORT一样，那么这个NAT是一个cone NAT，进行第4步
    -->当UDP包与第1步中的UDP包的NAT的IP和PORT相比，如果PORT不一样，那么这个NAT是一个对称(Symmetric NAT)，对称NAT不能用P2P了,用其它方式连接吧
   
---->4.Client向Server2:PORT(任意PORT)发送一个UDP包，Server2用不同于PORT(前面的任意PORT)的另一个PORT返回一个数据包给Client
    -->当Client收到UDP包，就是restricted cone NAT.
    -->当Client没有收到UDP包,就是port restrict NAT.


NAT的出现：
    当Client端向Server端发送UDP包时,如果Client端不是在公网上,那么Client端的IP和PORT会被换成NAT设备的IP和PORT
    那么到达Server端的UDP包的IP和PORT就是NAT设备的.
    
对于NAT请求Server：

        Server1:PORT1                                               Server2:PORT2
     119.139.199.217:9123                                         116.24.66.177:9123
              |                                                             |        
              |                                                             |
              +-------------------------------+-----------------------------+      
                                              |  
                                              |     
               SessionNAT1(NAT-Server1)       |     SessionNAT2(NAT-Server2)
               119.139.199.217:9123           |     116.24.66.177:9123
               188.188.188.188:12345          |     188.188.188.188:12345
                                              |     
                                              |
                                           Cone NAT     
                                        188.188.188.188
                                              |  
                                              |     
               SessionClient1(Client-Server1) |     SessionClient2(Client-Server2)
               119.139.199.217:9123           |     116.24.66.177:9123
               192.168.1.1:1234               |     192.168.1.1:1234
                                              |     
                                              |
                                            Client
                                        192.168.1.1:1234


关于NAT如何分类:
    首先看请求过程
    ->当Client端向Server1:PORT1请求数据,请求经过NAT,NAT会将请求的IP与PORT替换成NAT的IP和PORT,这样就形成了是NAT向Server1:PORT1请求
    ->然后我们根据请求过程与数据返回过程形成的几个过程对NAT进行分类
    
Full Cone(全圆锥):
    NAT把所有来自相同内部IP地址和端口(如图上的192.168.1.1:1234)的请求映射到相同的外部IP地址和端口(如图上的SessionNATive1就会变成188.188.188.188:1234,端口而不是12345)
    任何一部主机都可以通过该NAT的IP和端口可以发送数据包到Client端
    
Restricted Cone(限制性圆锥):
    NAT把所有来自相同内部IP地址和端口的请求映射到相同的外部IP和端口.
    但是只有内部主机先给外部IP地址发送数据包,该外部主机才能向该内部IP地址和端口发送数据
    
Port Restricted Cone(端口限制性圆锥):
    与限制性圆锥一样,但是多了端口的限制.就是限制性圆锥不论什么端口都可以发送成功,而这个需要加上端口的限制.

Symmetric NAT(对称性NAT):
    当Client端向Server1发送数据包时,ConeNat会分配一个12345的端口号(如上图的SessionNAT中所示)
    然后收到Server1的数据返回后,给Server2发送数据包时,CodeNAT就会再次分配一个端口号(如SessionNAT2的所示,不一样的是188.188.188.188:12345的端口会变,变成其它端口了,例如188.188.188.188:8888)















                                        
                                        